<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WB Mobile Store</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5080BE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJkZXNjcmlwdGlvbiI6IldCIE1vYmlsZSBTdG9yZSAtIFByZW1pdW0gTW9iaWxlcyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzY0NC82NDQ0NTgucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XSwibmFtZSI6IldCIE1vYmlsZSBTdG9yZSIsInNob3J0X25hbWUiOiJXQiBTdG9yZSIsInN0YXJ0X3VybCI6Ii8iLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI0UwRjJGQyIsInRoZW1lX2NvbG9yIjoiIzUwODBCRSJ9">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#E0F2FC',
                            secondary: '#C6DEF6',
                            primary: '#5080BE',
                            accent: '#7EBBDA',
                            card: '#E6F5FA',
                            text: '#2c3e50'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        window.onerror = function(message, source, lineno, colno, error) {
    alert("System Error: " + message);
};

window.addEventListener('unhandledrejection', function(event) {
    alert("Async Error: " + event.reason);
});
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config & Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyBx724MefpWjw6KfUMX9o7BkygQ5xeD02k",
            authDomain: "wb-mobile-store.firebaseapp.com",
            projectId: "wb-mobile-store",
            storageBucket: "wb-mobile-store.firebasestorage.app",
            messagingSenderId: "54481231902",
            appId: "1:54481231902:web:395ad38266e975fae6ce0f",
            measurementId: "G-5R648HZ40T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'wb-mobile-store-v1'; // App ID for pathing

        // --- Global State ---
        window.state = {
            user: null,
            isAdmin: false,
            products: [],
            cart: JSON.parse(localStorage.getItem('wb_cart')) || [],
            banners: [],
            orders: [],
            categories: ["Smartphones", "Tablets", "Accessories", "Earbuds", "Chargers"],
            currentView: 'home',
            settings: {
                upiId: 'wbstore@okicici',
                codEnabled: true,
                upiEnabled: true
            }
        };

        const ADMIN_EMAIL = "wbstore.india@gmail.com";

        // --- DOM Elements ---
        const els = {
            app: document.getElementById('app'),
            nav: document.getElementById('navbar'),
            mobileNav: document.getElementById('mobile-nav'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('modal')
        };

        // --- Cloudinary Config ---
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dyt6fwvw0/image/upload";
        const CLOUDINARY_PRESET = "Wb_mobile_products";

        // --- Helpers ---
        const formatPrice = (p) => `₹${Number(p).toLocaleString('en-IN')}`;
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        function showToast(msg, type = 'info') {
            els.toast.textContent = msg;
            els.toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded shadow-lg transition-opacity duration-300 transform translate-y-0 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-brand-primary text-white'}`;
            els.toast.classList.remove('hidden', 'opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 2500);
            setTimeout(() => els.toast.classList.add('hidden'), 3000);
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            
            try {
                const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await res.json();
                return data.secure_url;
            } catch (err) {
                console.error("Upload failed", err);
                showToast("Image upload failed", 'error');
                return null;
            }
        }

        // --- Auth Functions ---
        window.login = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const pass = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showToast("Welcome back!");
                navigate('home');
            } catch (err) {
                showToast(err.message, 'error');
            }
        };

        window.register = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const pass = e.target.password.value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                showToast("Account created!");
                navigate('home');
            } catch (err) {
                showToast(err.message, 'error');
            }
        };

        window.logout = async () => {
            await signOut(auth);
            navigate('login');
        };

        // --- Data Layer ---
        function listenToData() {
            // Products
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                window.state.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (window.state.currentView === 'home') renderHome();
                if (window.state.currentView === 'admin-products') renderAdminProducts();
            });

            // Banners
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), (snap) => {
                window.state.banners = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (window.state.currentView === 'home') renderHome();
                if (window.state.currentView === 'admin-banners') renderAdminBanners();
            });

            // Orders (If Admin)
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snap) => {
                window.state.orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Sort by date desc
                window.state.orders.sort((a,b) => b.createdAt?.seconds - a.createdAt?.seconds);
                if (window.state.currentView === 'orders') renderOrders();
                if (window.state.currentView === 'admin-orders') renderAdminOrders();
                if (window.state.currentView === 'admin-dashboard') renderAdminDashboard();
            });
        }

        // --- Navigation ---
        window.navigate = (view, params = {}) => {
            window.state.currentView = view;
            window.scrollTo(0,0);
            
            // Render Layout
            renderNavbar();
            
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-primary"></div></div>';

            setTimeout(() => {
                switch(view) {
                    case 'home': renderHome(); break;
                    case 'product': renderProductDetail(params.id); break;
                    case 'cart': renderCart(); break;
                    case 'checkout': renderCheckout(); break;
                    case 'login': renderAuth('login'); break;
                    case 'register': renderAuth('register'); break;
                    case 'orders': renderOrders(); break;
                    case 'admin-dashboard': renderAdminDashboard(); break;
                    case 'admin-products': renderAdminProducts(); break;
                    case 'admin-orders': renderAdminOrders(); break;
                    case 'admin-banners': renderAdminBanners(); break;
                    default: renderHome();
                }
                lucide.createIcons();
            }, 100);
        };

        // --- Renderers ---
        function renderNavbar() {
            const count = window.state.cart.reduce((a,b) => a + b.qty, 0);
            const userHtml = window.state.user ? 
                `<div class="relative group cursor-pointer">
                    <i data-lucide="user" class="text-brand-primary"></i>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded shadow-xl hidden group-hover:block z-50 border border-brand-secondary">
                        ${window.state.isAdmin ? `<div onclick="navigate('admin-dashboard')" class="p-3 hover:bg-brand-bg font-bold text-brand-primary">Admin Panel</div>` : ''}
                        <div onclick="navigate('orders')" class="p-3 hover:bg-brand-bg text-gray-700">My Orders</div>
                        <div onclick="logout()" class="p-3 hover:bg-brand-bg text-red-500">Logout</div>
                    </div>
                 </div>` : 
                `<button onclick="navigate('login')" class="text-sm font-bold text-brand-primary">Login</button>`;

            els.nav.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                    <div onclick="navigate('home')" class="flex items-center gap-2 cursor-pointer">
                        <div class="w-8 h-8 bg-brand-primary rounded flex items-center justify-center text-white font-bold text-lg">WB</div>
                        <span class="font-bold text-xl tracking-tight text-brand-primary">Mobile Store</span>
                    </div>
                    
                    <div class="hidden md:flex flex-1 max-w-md mx-8 relative">
                        <input type="text" id="searchInput" placeholder="Search for mobiles, accessories..." 
                               class="w-full pl-10 pr-4 py-2 rounded bg-brand-card border border-brand-secondary focus:outline-none focus:border-brand-primary text-gray-700 placeholder-gray-400"
                               oninput="handleSearch(this.value)">
                        <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                    </div>

                    <div class="flex items-center gap-6">
                        <div onclick="navigate('cart')" class="relative cursor-pointer">
                            <i data-lucide="shopping-cart" class="text-brand-primary w-6 h-6"></i>
                            ${count > 0 ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">${count}</span>` : ''}
                        </div>
                        ${userHtml}
                    </div>
                </div>
            `;
            
            // Mobile Nav
            els.mobileNav.innerHTML = `
                <div class="grid grid-cols-4 h-full">
                    <button onclick="navigate('home')" class="flex flex-col items-center justify-center text-gray-600 hover:text-brand-primary ${window.state.currentView === 'home' ? 'text-brand-primary' : ''}">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1">Home</span>
                    </button>
                    <button onclick="navigate('home')" class="flex flex-col items-center justify-center text-gray-600 hover:text-brand-primary">
                        <i data-lucide="grid" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1">Cats</span>
                    </button>
                    <button onclick="navigate('cart')" class="flex flex-col items-center justify-center text-gray-600 hover:text-brand-primary relative">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        ${count > 0 ? `<span class="absolute top-2 right-6 bg-red-500 text-white text-[8px] font-bold rounded-full w-4 h-4 flex items-center justify-center">${count}</span>` : ''}
                        <span class="text-[10px] mt-1">Cart</span>
                    </button>
                    <button onclick="${window.state.user ? "navigate('orders')" : "navigate('login')"}" class="flex flex-col items-center justify-center text-gray-600 hover:text-brand-primary">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1">Account</span>
                    </button>
                </div>
            `;
        }

        window.handleSearch = (term) => {
            const content = document.getElementById('product-grid');
            if (!content) return;
            const filtered = window.state.products.filter(p => p.name.toLowerCase().includes(term.toLowerCase()) || p.brand.toLowerCase().includes(term.toLowerCase()));
            content.innerHTML = filtered.map(productCard).join('');
            lucide.createIcons();
        };

        const productCard = (p) => `
            <div onclick="navigate('product', {id: '${p.id}'})" class="bg-brand-card rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow cursor-pointer flex flex-col h-full border border-transparent hover:border-brand-secondary">
                <div class="aspect-square bg-white rounded-md mb-3 flex items-center justify-center overflow-hidden relative">
                    <img src="${p.image || 'https://via.placeholder.com/150'}" class="object-contain h-full w-full" alt="${p.name}" onerror="this.src='https://placehold.co/200x200/png?text=No+Image'">
                    ${p.stock <= 0 ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold text-sm">OUT OF STOCK</div>' : ''}
                </div>
                <div class="flex-1 flex flex-col">
                    <p class="text-xs text-brand-primary font-bold uppercase tracking-wider mb-1">${p.brand}</p>
                    <h3 class="font-medium text-gray-800 text-sm leading-tight mb-1 line-clamp-2 h-10">${p.name}</h3>
                    <div class="mt-auto">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg font-bold text-gray-900">${formatPrice(p.discountPrice || p.price)}</span>
                            ${p.discountPrice ? `<span class="text-xs text-gray-500 line-through">${formatPrice(p.price)}</span>` : ''}
                            ${p.discountPrice ? `<span class="text-xs text-green-600 font-bold">${Math.round(((p.price - p.discountPrice)/p.price)*100)}% OFF</span>` : ''}
                        </div>
                        ${p.stock > 0 ? 
                            `<button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-brand-primary text-white py-2 rounded text-sm font-medium hover:bg-blue-600 active:scale-95 transition-transform">Add to Cart</button>` :
                            `<button disabled class="w-full bg-gray-300 text-gray-500 py-2 rounded text-sm font-medium cursor-not-allowed">Notify Me</button>`
                        }
                    </div>
                </div>
            </div>
        `;

        function renderHome() {
            const activeBanners = window.state.banners.filter(b => b.active);
            const bannerHtml = activeBanners.length > 0 ? `
                <div class="relative w-full h-48 md:h-80 overflow-hidden mb-6 rounded-xl shadow-lg group">
                    <div class="flex transition-transform duration-500 h-full" id="bannerSlider">
                        ${activeBanners.map(b => `<img src="${b.url}" class="w-full h-full object-cover flex-shrink-0">`).join('')}
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
                    <div class="absolute bottom-4 left-4 text-white">
                        <h2 class="text-2xl font-bold">Latest Offers</h2>
                        <p class="text-sm opacity-90">Grab them before they're gone</p>
                    </div>
                </div>
            ` : `<div class="w-full h-48 bg-gradient-to-r from-brand-primary to-brand-accent rounded-xl mb-6 flex items-center justify-center text-white shadow-lg"><h2 class="text-2xl font-bold">Welcome to WB Mobile Store</h2></div>`;
            
            // Auto slide banners logic can be added here
            
            document.getElementById('content').innerHTML = `
                <div class="max-w-7xl mx-auto px-4 pb-20 pt-4">
                    ${bannerHtml}
                    
       <!-- Categories -->
                    <div class="flex overflow-x-auto gap-4 mb-8 pb-2 scrollbar-hide">
                        ${window.state.categories.map(c => `
                            <div class="flex-shrink-0 flex flex-col items-center gap-2 cursor-pointer group" onclick="document.getElementById('searchInput').value='${c}'; handleSearch('${c}')">
                                <div class="w-16 h-16 rounded-full bg-white shadow-sm flex items-center justify-center group-hover:shadow-md border border-brand-secondary">
                                    <i data-lucide="${c === 'Smartphones' ? 'smartphone' : c === 'Headphones' ? 'headphones' : 'tag'}" class="text-brand-primary"></i>
                                </div>
                                <span class="text-xs font-medium text-gray-600 group-hover:text-brand-primary">${c}</span>
                            </div>
                        `).join('')}
                    </div>

                    <h2 class="text-xl font-bold text-gray-800 mb-4 px-1 border-l-4 border-brand-primary pl-3">Featured Products</h2>
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-6">
                        ${window.state.products.map(productCard).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderProductDetail(id) {
            const p = window.state.products.find(x => x.id === id);
            if(!p) return navigate('home');

            document.getElementById('content').innerHTML = `
                <div class="max-w-5xl mx-auto px-4 py-6 pb-24">
                    <button onclick="navigate('home')" class="mb-4 text-brand-primary flex items-center gap-1 font-medium"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-brand-secondary overflow-hidden">
                        <div class="grid md:grid-cols-2">
                            <div class="p-6 bg-white flex items-center justify-center border-b md:border-b-0 md:border-r border-brand-secondary">
                                <img src="${p.image}" class="max-h-80 object-contain hover:scale-105 transition-transform duration-300">
                            </div>
                            <div class="p-6 md:p-8 bg-brand-card">
                                <span class="bg-brand-secondary text-brand-primary text-xs font-bold px-2 py-1 rounded uppercase mb-2 inline-block">${p.brand}</span>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">${p.name}</h1>
                                
                                <div class="flex items-end gap-3 mb-6">
                                    <span class="text-3xl font-bold text-brand-primary">${formatPrice(p.discountPrice || p.price)}</span>
                                    ${p.discountPrice ? `<span class="text-lg text-gray-400 line-through mb-1">${formatPrice(p.price)}</span>` : ''}
                                </div>

                                <div class="space-y-4 mb-8">
                                    <p class="text-gray-600 leading-relaxed text-sm">${p.desc || 'No description available for this product.'}</p>
                                    
                                    <div class="flex gap-4 text-sm text-gray-600">
                                        <div class="flex items-center gap-2 bg-white px-3 py-2 rounded border border-brand-secondary">
                                            <i data-lucide="shield-check" class="text-green-500 w-4 h-4"></i> 1 Year Warranty
                                        </div>
                                        <div class="flex items-center gap-2 bg-white px-3 py-2 rounded border border-brand-secondary">
                                            <i data-lucide="truck" class="text-brand-primary w-4 h-4"></i> Free Delivery
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-3 fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 md:static md:bg-transparent md:border-0 md:p-0 z-10">
                                    <button onclick="addToCart('${p.id}')" class="flex-1 bg-white border-2 border-brand-primary text-brand-primary py-3 rounded-lg font-bold hover:bg-brand-bg transition-colors">Add to Cart</button>
                                    <button onclick="addToCart('${p.id}'); navigate('cart')" class="flex-1 bg-brand-primary text-white py-3 rounded-lg font-bold hover:bg-blue-600 shadow-lg shadow-blue-200">Buy Now</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reviews Section -->
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Customer Reviews</h3>
                        <div class="bg-white p-6 rounded-xl border border-brand-secondary text-center text-gray-500">
                            <i data-lucide="message-square" class="mx-auto w-10 h-10 mb-2 opacity-50"></i>
                            <p>No reviews yet. Be the first to review!</p>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.addToCart = (id) => {
            const p = window.state.products.find(x => x.id === id);
            const exist = window.state.cart.find(x => x.id === id);
            if(exist) {
                exist.qty++;
            } else {
                window.state.cart.push({ ...p, qty: 1 });
            }
            saveCart();
            renderNavbar();
            showToast("Added to Cart!");
        };

        window.updateQty = (id, delta) => {
            const item = window.state.cart.find(x => x.id === id);
            if(item) {
                item.qty += delta;
                if(item.qty <= 0) window.state.cart = window.state.cart.filter(x => x.id !== id);
                saveCart();
                renderCart();
                renderNavbar();
            }
        };

        function saveCart() {
            localStorage.setItem('wb_cart', JSON.stringify(window.state.cart));
        }

        function renderCart() {
            const total = window.state.cart.reduce((a,b) => a + ((b.discountPrice || b.price) * b.qty), 0);
            
            document.getElementById('content').innerHTML = `
                <div class="max-w-3xl mx-auto px-4 py-6 pb-24">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Shopping Cart</h2>
                    
                    ${window.state.cart.length === 0 ? `
                        <div class="text-center py-12">
                            <div class="w-24 h-24 bg-brand-bg rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="shopping-cart" class="w-10 h-10 text-brand-primary"></i>
                            </div>
                            <p class="text-gray-500 mb-4">Your cart is empty</p>
                            <button onclick="navigate('home')" class="bg-brand-primary text-white px-6 py-2 rounded font-medium">Start Shopping</button>
                        </div>
                    ` : `
                        <div class="space-y-4 mb-24">
                            ${window.state.cart.map(item => `
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary flex gap-4">
                                    <img src="${item.image}" class="w-20 h-20 object-contain bg-gray-50 rounded">
                                    <div class="flex-1">
                                        <h3 class="font-medium text-gray-800 line-clamp-1">${item.name}</h3>
                                        <p class="text-brand-primary font-bold mt-1">${formatPrice(item.discountPrice || item.price)}</p>
                                        <div class="flex items-center gap-3 mt-3">
                                            <button onclick="updateQty('${item.id}', -1)" class="w-7 h-7 rounded-full bg-brand-bg text-brand-primary flex items-center justify-center hover:bg-brand-secondary">-</button>
                                            <span class="font-medium w-4 text-center">${item.qty}</span>
                                            <button onclick="updateQty('${item.id}', 1)" class="w-7 h-7 rounded-full bg-brand-bg text-brand-primary flex items-center justify-center hover:bg-brand-secondary">+</button>
                                        </div>
                                    </div>
                                    <button onclick="updateQty('${item.id}', -100)" class="text-red-500 self-start"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>

                        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg md:static md:shadow-none md:border md:rounded-xl md:mt-6">
                            <div class="max-w-3xl mx-auto">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-gray-600">Total Amount</span>
                                    <span class="text-2xl font-bold text-brand-primary">${formatPrice(total)}</span>
                                </div>
                                <button onclick="${window.state.user ? "navigate('checkout')" : "showToast('Please Login First', 'error'); navigate('login')"}" class="w-full bg-brand-primary text-white py-3 rounded-lg font-bold hover:bg-blue-600">Proceed to Checkout</button>
                            </div>
                        </div>
                    `}
                </div>
            `;
            lucide.createIcons();
        }

        function renderCheckout() {
            const total = window.state.cart.reduce((a,b) => a + ((b.discountPrice || b.price) * b.qty), 0);
            document.getElementById('content').innerHTML = `
                <div class="max-w-2xl mx-auto px-4 py-6 pb-24">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <button onclick="navigate('cart')"><i data-lucide="arrow-left"></i></button> Checkout
                    </h2>
                    
                    <form id="checkoutForm" onsubmit="placeOrder(event)" class="space-y-6">
                        <div class="bg-white p-5 rounded-xl border border-brand-secondary shadow-sm">
                            <h3 class="font-bold text-brand-primary mb-4 text-sm uppercase tracking-wide">Shipping Details</h3>
                            <div class="grid gap-4">
                                <input required name="name" placeholder="Full Name" class="w-full p-3 border rounded focus:border-brand-primary focus:outline-none" value="${window.state.user.displayName || ''}">
                                <input required name="mobile" type="tel" placeholder="Mobile Number" class="w-full p-3 border rounded focus:border-brand-primary focus:outline-none">
                                <textarea required name="address" placeholder="Full Address (House No, Street, Area)" class="w-full p-3 border rounded focus:border-brand-primary focus:outline-none"></textarea>
                                <div class="grid grid-cols-2 gap-4">
                                    <input required name="city" placeholder="City" class="w-full p-3 border rounded focus:border-brand-primary focus:outline-none">
                                    <input required name="pincode" placeholder="Pincode" class="w-full p-3 border rounded focus:border-brand-primary focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-xl border border-brand-secondary shadow-sm">
                            <h3 class="font-bold text-brand-primary mb-4 text-sm uppercase tracking-wide">Payment Method</h3>
                            <div class="space-y-3">
                                ${window.state.settings.codEnabled ? `
                                <label class="flex items-center gap-3 p-3 border rounded cursor-pointer hover:bg-brand-bg transition-colors">
                                    <input type="radio" name="payment" value="COD" checked class="accent-brand-primary w-5 h-5">
                                    <span class="font-medium">Cash on Delivery</span>
                                </label>` : ''}
                                
                                ${window.state.settings.upiEnabled ? `
                                <label class="flex items-center gap-3 p-3 border rounded cursor-pointer hover:bg-brand-bg transition-colors">
                                    <input type="radio" name="payment" value="UPI" class="accent-brand-primary w-5 h-5">
                                    <div class="flex-1">
                                        <span class="font-medium block">UPI Payment</span>
                                        <span class="text-xs text-gray-500">Scan QR Code on next step</span>
                                    </div>
                                    <i data-lucide="qr-code" class="text-brand-primary"></i>
                                </label>` : ''}
                            </div>
                        </div>

                        <div class="bg-brand-card p-4 rounded-lg flex justify-between items-center">
                            <span class="font-bold text-gray-700">Total To Pay</span>
                            <span class="font-bold text-xl text-brand-primary">${formatPrice(total)}</span>
                        </div>

                        <button type="submit" class="w-full bg-brand-primary text-white py-4 rounded-lg font-bold hover:bg-blue-600 shadow-lg shadow-blue-200 transition-all">Confirm Order</button>
                    </form>
                </div>
            `;
            lucide.createIcons();
        }

        window.placeOrder = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const orderData = {
                items: window.state.cart,
                total: window.state.cart.reduce((a,b) => a + ((b.discountPrice || b.price) * b.qty), 0),
                customer: {
                    name: formData.get('name'),
                    mobile: formData.get('mobile'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    pincode: formData.get('pincode'),
                    id: window.state.user.uid,
                    email: window.state.user.email
                },
                paymentMethod: formData.get('payment'),
                status: 'Pending',
                createdAt: serverTimestamp(),
                userId: window.state.user.uid // Critical for admin/user filtering
            };
                      // If UPI, show mock modal
            if(orderData.paymentMethod === 'UPI') {
                const confirmed = confirm(`Pay to UPI ID: ${window.state.settings.upiId}\nAmount: ${formatPrice(orderData.total)}\n\nClick OK after payment is done.`);
                if(!confirmed) return;
            }

            try {
                // Rule 1: Correct path
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                window.state.cart = [];
                saveCart();
                showToast("Order Placed Successfully!");
                navigate('orders');
            } catch(err) {
                console.error(err);
                showToast("Order failed. Try again.", 'error');
            }
        };

        function renderOrders() {
            const myOrders = window.state.orders.filter(o => o.userId === window.state.user.uid);
            document.getElementById('content').innerHTML = `
                <div class="max-w-3xl mx-auto px-4 py-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">My Orders</h2>
                    <div class="space-y-4">
                        ${myOrders.length === 0 ? '<p class="text-gray-500">No orders found.</p>' : myOrders.map(o => `
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary">
                                <div class="flex justify-between items-start mb-4 border-b pb-2">
                                    <div>
                                        <span class="font-bold text-brand-primary block">#${o.id.slice(0,8).toUpperCase()}</span>
                                        <span class="text-xs text-gray-500">${o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${getStatusColor(o.status)}">${o.status}</span>
                                </div>
                                <div class="space-y-2 mb-4">
                                    ${o.items.map(i => `
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">${i.qty}x ${i.name}</span>
                                            <span class="font-medium">${formatPrice(i.discountPrice || i.price)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t text-sm">
                                    <span class="text-gray-500">${o.paymentMethod}</span>
                                    <span class="font-bold text-lg">${formatPrice(o.total)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const getStatusColor = (s) => {
            if(s === 'Pending') return 'bg-yellow-100 text-yellow-800';
            if(s === 'Approved') return 'bg-blue-100 text-blue-800';
            if(s === 'Shipped') return 'bg-purple-100 text-purple-800';
            if(s === 'Delivered') return 'bg-green-100 text-green-800';
            return 'bg-red-100 text-red-800';
        }

        function renderAuth(type) {
            const isLogin = type === 'login';
            document.getElementById('content').innerHTML = `
                <div class="min-h-[calc(100vh-200px)] flex items-center justify-center px-4">
                    <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-lg border border-brand-secondary">
                        <h2 class="text-2xl font-bold text-center text-brand-primary mb-6">${isLogin ? 'Welcome Back' : 'Create Account'}</h2>
                        <form onsubmit="${isLogin ? 'login(event)' : 'register(event)'}" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input name="email" type="email" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input name="password" type="password" required minlength="6" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-brand-primary focus:outline-none">
                            </div>
                            <button class="w-full bg-brand-primary text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">${isLogin ? 'Login' : 'Register'}</button>
                        </form>
                        <p class="text-center mt-6 text-sm text-gray-600">
                            ${isLogin ? "Don't have an account?" : "Already have an account?"} 
                            <button onclick="navigate('${isLogin ? 'register' : 'login'}')" class="text-brand-primary font-bold hover:underline">${isLogin ? 'Sign Up' : 'Login'}</button>
                        </p>
                    </div>
                </div>
            `;
        }

        // --- ADMIN SECTION ---
        function renderAdminDashboard() {
            if(!window.state.isAdmin) return navigate('home');
            
            const totalRevenue = window.state.orders.reduce((a,b) => a + (b.status !== 'Rejected' ? b.total : 0), 0);
            const pending = window.state.orders.filter(o => o.status === 'Pending').length;

            document.getElementById('content').innerHTML = `
                <div class="flex min-h-screen bg-brand-bg">
                    <!-- Admin Sidebar -->
                    <div class="w-64 bg-white shadow-lg hidden md:block">
                        <div class="p-6 font-bold text-xl text-brand-primary border-b">Admin Panel</div>
                        <nav class="p-4 space-y-2">
                            <button onclick="navigate('admin-dashboard')" class="w-full text-left p-3 rounded bg-brand-bg text-brand-primary font-bold">Dashboard</button>
                            <button onclick="navigate('admin-products')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600">Products</button>
                            <button onclick="navigate('admin-orders')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600">Orders (${pending})</button>
                            <button onclick="navigate('admin-banners')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600">Banners</button>
                            <button onclick="navigate('home')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600 mt-8 border-t">Back to Store</button>
                        </nav>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-brand-primary">
                                <h3 class="text-gray-500 text-sm font-bold uppercase">Total Revenue</h3>
                                <p class="text-2xl font-bold text-gray-800 mt-2">${formatPrice(totalRevenue)}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-400">
                                <h3 class="text-gray-500 text-sm font-bold uppercase">Pending Orders</h3>
                                <p class="text-2xl font-bold text-gray-800 mt-2">${pending}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-400">
                                <h3 class="text-gray-500 text-sm font-bold uppercase">Total Orders</h3>
                                <p class="text-2xl font-bold text-gray-800 mt-2">${window.state.orders.length}</p>
                            </div>
                             <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-400">
                                <h3 class="text-gray-500 text-sm font-bold uppercase">Products</h3>
                                <p class="text-2xl font-bold text-gray-800 mt-2">${window.state.products.length}</p>
                            </div>
                        </div>

                        <!-- Mobile Menu for Admin -->
                        <div class="md:hidden grid grid-cols-2 gap-4 mb-6">
                             <button onclick="navigate('admin-products')" class="bg-white p-4 rounded shadow text-center font-bold">Manage Products</button>
                             <button onclick="navigate('admin-orders')" class="bg-white p-4 rounded shadow text-center font-bold">Manage Orders</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminProducts() {
            if(!window.state.isAdmin) return;
            document.getElementById('content').innerHTML = `
                <div class="max-w-6xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Product Management</h2>
                        <button onclick="document.getElementById('addProductModal').classList.remove('hidden')" class="bg-brand-primary text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-blue-600 transition-colors"><i data-lucide="plus"></i> Add Product</button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50 text-gray-600 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="p-4">Image</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Price</th>
                                        <th class="p-4">Stock</th>
                                        <th class="p-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${window.state.products.map(p => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="p-4"><img src="${p.image}" class="w-12 h-12 object-contain rounded bg-white border"></td>
                                            <td class="p-4 font-medium">${p.name}<br><span class="text-xs text-gray-400">${p.brand}</span></td>
                                            <td class="p-4">${formatPrice(p.discountPrice || p.price)}</td>
                                            <td class="p-4">
                                                <span class="px-2 py-1 rounded text-xs font-bold ${p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${p.stock > 0 ? p.stock + ' In Stock' : 'Out of Stock'}</span>
                                            </td>
                                            <td class="p-4">
                                                <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
<!-- Add Product Modal -->
                    <div id="addProductModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b flex justify-between items-center">
                                <h3 class="font-bold text-lg">Add New Product</h3>
                                <button onclick="document.getElementById('addProductModal').classList.add('hidden')" class="text-gray-500"><i data-lucide="x"></i></button>
                            </div>
                            <form onsubmit="addProduct(event)" class="p-6 space-y-4">
                                <input name="name" required placeholder="Product Name" class="w-full p-2 border rounded">
                                <div class="grid grid-cols-2 gap-4">
                                    <input name="brand" required placeholder="Brand" class="w-full p-2 border rounded">
                                    <select name="category" class="w-full p-2 border rounded">
                                        ${window.state.categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <input name="price" type="number" required placeholder="Price (₹)" class="w-full p-2 border rounded">
                                    <input name="discountPrice" type="number" placeholder="Discount Price (₹)" class="w-full p-2 border rounded">
                                </div>
                                <input name="stock" type="number" required placeholder="Stock Quantity" class="w-full p-2 border rounded">
                                <textarea name="desc" placeholder="Description" class="w-full p-2 border rounded"></textarea>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Product Image</label>
                                    <input type="file" required id="prodImgInput" accept="image/*" class="w-full">
                                </div>

                                <button type="submit" id="addProdBtn" class="w-full bg-brand-primary text-white py-3 rounded font-bold hover:bg-blue-600">Add Product</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.addProduct = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('addProdBtn');
            const origText = btn.innerText;
            btn.innerText = "Uploading...";
            btn.disabled = true;

            const file = document.getElementById('prodImgInput').files[0];
            const url = await uploadImage(file);

            if(url) {
                const formData = new FormData(e.target);
                const data = {
                    name: formData.get('name'),
                    brand: formData.get('brand'),
                    category: formData.get('category'),
                    price: Number(formData.get('price')),
                    discountPrice: Number(formData.get('discountPrice')) || null,
                    stock: Number(formData.get('stock')),
                    desc: formData.get('desc'),
                    image: url,
                    createdAt: serverTimestamp()
                };
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
                document.getElementById('addProductModal').classList.add('hidden');
                e.target.reset();
                showToast("Product Added!");
            }
            btn.innerText = origText;
            btn.disabled = false;
        };

        window.deleteProduct = async (id) => {
            if(confirm("Are you sure?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                showToast("Product Deleted");
            }
        };

        function renderAdminOrders() {
            if(!window.state.isAdmin) return;
            document.getElementById('content').innerHTML = `
                <div class="max-w-6xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Order Management</h2>
                    <div class="space-y-4">
                        ${window.state.orders.map(o => `
                            <div class="bg-white p-4 rounded-lg shadow border border-brand-secondary">
                                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 border-b pb-4 mb-4">
                                    <div>
                                        <span class="font-bold text-lg text-brand-primary">#${o.id.slice(0,8).toUpperCase()}</span>
                                        <div class="text-sm text-gray-500">${new Date(o.createdAt?.seconds*1000).toLocaleString()}</div>
                                        <div class="text-sm mt-1">
                                            <span class="font-bold">Customer:</span> ${o.customer.name} | ${o.customer.mobile}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <select onchange="updateStatus('${o.id}', this.value)" class="p-2 border rounded bg-gray-50 text-sm font-bold">
                                            ${['Pending', 'Approved', 'Shipped', 'Delivered', 'Rejected'].map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded text-sm">
                                    <p class="font-bold mb-2">Items:</p>
                                    ${o.items.map(i => `<div class="flex justify-between border-b border-gray-200 last:border-0 py-1"><span>${i.qty}x ${i.name}</span><span>${formatPrice(i.price)}</span></div>`).join('')}
                                    <div class="flex justify-between font-bold pt-2 mt-2 border-t border-gray-300">
                                        <span>Total (${o.paymentMethod})</span>
                                        <span>${formatPrice(o.total)}</span>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500">Address: ${o.customer.address}, ${o.customer.city}, ${o.customer.pincode}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status });
            showToast("Order Status Updated");
        };

        function renderAdminBanners() {
            if(!window.state.isAdmin) return;
            document.getElementById('content').innerHTML = `
                <div class="max-w-4xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Banner Management</h2>
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm mb-8 border border-brand-secondary">
                        <h3 class="font-bold mb-4">Upload New Banner</h3>
                        <div class="flex gap-4">
                            <input type="file" id="bannerInput" class="flex-1 p-2 border rounded">
                            <button onclick="uploadBanner()" class="bg-brand-primary text-white px-6 rounded font-bold hover:bg-blue-600">Upload</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${window.state.banners.map(b => `
                            <div class="relative group bg-white rounded-lg overflow-hidden shadow">
                                <img src="${b.url}" class="w-full h-40 object-cover">
                                <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center gap-4">
                                    <button onclick="deleteBanner('${b.id}')" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">Delete</button>
                                    <button onclick="toggleBanner('${b.id}', ${!b.active})" class="${b.active ? 'bg-yellow-500' : 'bg-green-500'} text-white p-2 rounded font-bold w-24">${b.active ? 'Disable' : 'Enable'}</button>
                                </div>
                                <div class="absolute top-2 right-2 px-2 py-1 rounded text-xs font-bold text-white ${b.active ? 'bg-green-500' : 'bg-red-500'}">${b.active ? 'Active' : 'Inactive'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.uploadBanner = async () => {
            const file = document.getElementById('bannerInput').files[0];
            if(!file) return showToast("Select a file first", 'error');
            
            showToast("Uploading Banner...", 'info');
            const url = await uploadImage(file);
            if(url) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), { url, active: true, createdAt: serverTimestamp() });
                showToast("Banner Uploaded!");
                document.getElementById('bannerInput').value = '';
            }
        };

        window.deleteBanner = async (id) => {
            if(confirm("Delete this banner?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id));
        };
        
        window.toggleBanner = async (id, active) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id), { active });
        };


        // --- Init ---
        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if(user) {
                window.state.isAdmin = (user.email === ADMIN_EMAIL);
            } else {
                window.state.isAdmin = false;
            }
            renderNavbar();
            listenToData(); // Start listeners
        });

        // Initial render
        renderNavbar();
        renderHome();

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar for Categories */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-[#F8FAFC] text-slate-800 pb-16 md:pb-0">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Desktop Nav -->
        <nav id="navbar" class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-40 h-16"></nav>

        <!-- Main Content -->
        <main id="content" class="flex-grow pt-4"></main>

        <!-- Mobile Bottom Nav -->
        <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 h-16 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"></nav>

        <!-- Toast Notification -->
        <div id="toast" class="hidden opacity-0 fixed top-4 right-4 bg-brand-primary text-white px-6 py-3 rounded shadow-lg transition-all duration-300 z-50"></div>
    </div>

</body>
</html>
