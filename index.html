<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WB Mobile Store</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5080BE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJkZXNjcmlwdGlvbiI6IldCIE1vYmlsZSBTdG9yZSAtIFByZW1pdW0gTW9iaWxlcyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzY0NC82NDQ0NTgucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9XSwibmFtZSI6IldCIE1vYmlsZSBTdG9yZSIsInNob3J0X25hbWUiOiJXQiBTdG9yZSIsInN0YXJ0X3VybCI6Ii8iLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI0UwRjJGQyIsInRoZW1lX2NvbG9yIjoiIzUwODBCRSJ9">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#E0F2FC',
                            secondary: '#C6DEF6',
                            primary: '#5080BE',
                            accent: '#7EBBDA',
                            card: '#E6F5FA',
                            text: '#2c3e50'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config & Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyBx724MefpWjw6KfUMX9o7BkygQ5xeD02k",
            authDomain: "wb-mobile-store.firebaseapp.com",
            projectId: "wb-mobile-store",
            storageBucket: "wb-mobile-store.firebasestorage.app",
            messagingSenderId: "54481231902",
            appId: "1:54481231902:web:395ad38266e975fae6ce0f",
            measurementId: "G-5R648HZ40T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'wb-mobile-store-v1';

        // --- Global State ---
        window.state = {
            user: null,
            isAdmin: false,
            products: [],
            cart: JSON.parse(localStorage.getItem('wb_cart')) || [],
            banners: [],
            orders: [],
            categories: ["Smartphones", "Tablets", "Accessories", "Earbuds", "Chargers"],
            currentView: 'home',
            settings: {
                upiId: 'wbstore@okicici',
                codEnabled: true,
                upiEnabled: true
            }
        };

        const ADMIN_EMAIL = "wbstore.india@gmail.com";

        // --- DOM Elements ---
        const els = {
            app: document.getElementById('app'),
            nav: document.getElementById('navbar'),
            mobileNav: document.getElementById('mobile-nav'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('modal')
        };

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dyt6fwvw0/image/upload";
        const CLOUDINARY_PRESET = "Wb_mobile_products";

        // --- Helpers ---
        const formatPrice = (p) => `â‚¹${Number(p).toLocaleString('en-IN')}`;
        
        function showToast(msg, type = 'info') {
            els.toast.textContent = msg;
            els.toast.className = `fixed top-4 right-4 z-[100] px-6 py-3 rounded shadow-lg transition-opacity duration-300 transform translate-y-0 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-brand-primary text-white'}`;
            els.toast.classList.remove('hidden', 'opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 2500);
            setTimeout(() => els.toast.classList.add('hidden'), 3000);
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            
            try {
                const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                if(!res.ok) throw new Error("Upload Failed");
                const data = await res.json();
                return data.secure_url;
            } catch (err) {
                console.error("Upload failed", err);
                showToast("Image upload failed: " + err.message, 'error');
                return null;
            }
        }

        // --- Auth Functions ---
        window.login = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const pass = e.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                showToast("Welcome back!");
                navigate('home');
            } catch (err) {
                showToast(err.message, 'error');
            }
        };

        window.register = async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const pass = e.target.password.value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                showToast("Account created!");
                navigate('home');
            } catch (err) {
                showToast(err.message, 'error');
            }
        };

        window.logout = async () => {
            await signOut(auth);
            navigate('login');
        };

        // --- Data Layer ---
        function listenToData() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                window.state.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (window.state.currentView === 'home') renderHome();
                if (window.state.currentView === 'admin-products') renderAdminProducts();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), (snap) => {
                window.state.banners = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (window.state.currentView === 'home') renderHome();
                if (window.state.currentView === 'admin-banners') renderAdminBanners();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snap) => {
                window.state.orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                window.state.orders.sort((a,b) => b.createdAt?.seconds - a.createdAt?.seconds);
                if (window.state.currentView === 'orders') renderOrders();
                if (window.state.currentView === 'admin-orders') renderAdminOrders();
                if (window.state.currentView === 'admin-dashboard') renderAdminDashboard();
            });
        }

        // --- Navigation ---
        window.navigate = (view, params = {}) => {
            window.state.currentView = view;
            window.scrollTo(0,0);
            renderNavbar();
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-primary"></div></div>';

            setTimeout(() => {
                switch(view) {
                    case 'home': renderHome(); break;
                    case 'product': renderProductDetail(params.id); break;
                    case 'cart': renderCart(); break;
                    case 'checkout': renderCheckout(); break;
                    case 'login': renderAuth('login'); break;
                    case 'register': renderAuth('register'); break;
                    case 'orders': renderOrders(); break;
                    case 'admin-dashboard': renderAdminDashboard(); break;
                    case 'admin-products': renderAdminProducts(); break;
                    case 'admin-orders': renderAdminOrders(); break;
                    case 'admin-banners': renderAdminBanners(); break;
                    default: renderHome();
                }
                lucide.createIcons();
            }, 50);
        };

        // --- Renderers ---
        function renderNavbar() {
            const count = window.state.cart.reduce((a,b) => a + b.qty, 0);
            
            // Desktop Nav
            els.nav.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                    <div onclick="navigate('home')" class="flex items-center gap-2 cursor-pointer">
                        <div class="w-8 h-8 bg-brand-primary rounded flex items-center justify-center text-white font-bold text-lg">WB</div>
                        <span class="font-bold text-xl tracking-tight text-brand-primary">Mobile Store</span>
                    </div>
                    
                    <div class="hidden md:flex flex-1 max-w-md mx-8 relative">
                        <input type="text" id="searchInput" placeholder="Search..." 
                               class="w-full pl-10 pr-4 py-2 rounded bg-brand-card border border-brand-secondary focus:outline-none focus:border-brand-primary"
                               oninput="handleSearch(this.value)">
                        <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                    </div>

                    <div class="flex items-center gap-6">
                        <div onclick="navigate('cart')" class="relative cursor-pointer hidden md:block">
                            <i data-lucide="shopping-cart" class="text-brand-primary w-6 h-6"></i>
                            ${count > 0 ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">${count}</span>` : ''}
                        </div>
                        
                        <!-- Desktop User Menu -->
                        ${window.state.user ? `
                            <div class="hidden md:flex relative group cursor-pointer items-center gap-2">
                                <span class="text-sm font-bold text-gray-700">My Account</span>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                                <div class="absolute right-0 top-full mt-2 w-48 bg-white rounded shadow-xl hidden group-hover:block z-50 border border-brand-secondary">
                                    ${window.state.isAdmin ? `<div onclick="navigate('admin-dashboard')" class="p-3 hover:bg-brand-bg font-bold text-brand-primary">Admin Panel</div>` : ''}
                                    <div onclick="navigate('orders')" class="p-3 hover:bg-brand-bg text-gray-700">My Orders</div>
                                    <div onclick="logout()" class="p-3 hover:bg-brand-bg text-red-500">Logout</div>
                                </div>
                            </div>
                        ` : `<button onclick="navigate('login')" class="hidden md:block text-sm font-bold text-brand-primary">Login</button>`}
                    </div>
                </div>
            `;
            
            // Mobile Bottom Nav
            // NOTE: Hiding bottom nav on specific pages if needed, but keeping it visible mostly
            els.mobileNav.innerHTML = `
                <div class="grid grid-cols-4 h-full bg-white">
                    <button onclick="navigate('home')" class="flex flex-col items-center justify-center text-gray-600 ${window.state.currentView === 'home' ? 'text-brand-primary' : ''}">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1">Home</span>
                    </button>
                    
                    <button onclick="navigate('cart')" class="flex flex-col items-center justify-center text-gray-600 relative ${window.state.currentView === 'cart' ? 'text-brand-primary' : ''}">
                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                        ${count > 0 ? `<span class="absolute top-1 right-6 bg-red-500 text-white text-[8px] font-bold rounded-full w-4 h-4 flex items-center justify-center">${count}</span>` : ''}
                        <span class="text-[10px] mt-1">Cart</span>
                    </button>
                    
                    <button onclick="${window.state.user ? "navigate('orders')" : "navigate('login')"}" class="flex flex-col items-center justify-center text-gray-600 ${window.state.currentView === 'orders' ? 'text-brand-primary' : ''}">
                        <i data-lucide="package" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1">Orders</span>
                    </button>
                    
                    <button onclick="${window.state.isAdmin ? "navigate('admin-dashboard')" : "navigate('login')"}" class="flex flex-col items-center justify-center text-gray-600 ${window.state.currentView.includes('admin') ? 'text-brand-primary' : ''}">
                        <i data-lucide="${window.state.isAdmin ? 'shield' : 'user'}" class="w-5 h-5"></i>
                        <span class="text-[10px] mt-1">${window.state.isAdmin ? 'Admin' : 'Login'}</span>
                    </button>
                </div>
            `;
        }

        window.handleSearch = (term) => {
            const content = document.getElementById('product-grid');
            if (!content) return;
            const filtered = window.state.products.filter(p => p.name.toLowerCase().includes(term.toLowerCase()) || p.brand.toLowerCase().includes(term.toLowerCase()));
            content.innerHTML = filtered.map(productCard).join('');
            lucide.createIcons();
        };

        const productCard = (p) => `
            <div onclick="navigate('product', {id: '${p.id}'})" class="bg-brand-card rounded-lg p-2 md:p-3 shadow-sm active:scale-95 transition-transform cursor-pointer flex flex-col h-full border border-transparent">
                <div class="aspect-square bg-white rounded-md mb-2 flex items-center justify-center overflow-hidden relative">
                    <img src="${p.image}" class="object-contain h-full w-full" alt="${p.name}" onerror="this.src='https://placehold.co/200x200/png?text=No+Image'">
                    ${p.stock <= 0 ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold text-xs">OUT OF STOCK</div>' : ''}
                </div>
                <div class="flex-1 flex flex-col">
                    <p class="text-[10px] text-brand-primary font-bold uppercase tracking-wider mb-0.5">${p.brand}</p>
                    <h3 class="font-medium text-gray-800 text-xs md:text-sm leading-tight mb-1 line-clamp-2 h-8">${p.name}</h3>
                    <div class="mt-auto">
                        <div class="flex items-center gap-1 md:gap-2 mb-2">
                            <span class="text-sm md:text-lg font-bold text-gray-900">${formatPrice(p.discountPrice || p.price)}</span>
                            ${p.discountPrice ? `<span class="text-[10px] text-gray-500 line-through">${formatPrice(p.price)}</span>` : ''}
                        </div>
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="w-full bg-brand-primary text-white py-1.5 md:py-2 rounded text-xs md:text-sm font-medium active:bg-blue-700">Add</button>
                    </div>
                </div>
            </div>
        `;

        function renderHome() {
            const activeBanners = window.state.banners.filter(b => b.active);
            const bannerHtml = activeBanners.length > 0 ? `
                <div class="relative w-full h-40 md:h-80 overflow-hidden mb-4 rounded-xl shadow-lg">
                    <div class="flex transition-transform duration-500 h-full overflow-x-auto snap-x snap-mandatory scrollbar-hide">
                        ${activeBanners.map(b => `<img src="${b.url}" class="w-full h-full object-cover flex-shrink-0 snap-center">`).join('')}
                    </div>
                </div>
            ` : '';
            
            document.getElementById('content').innerHTML = `
                <div class="max-w-7xl mx-auto px-3 pb-20 pt-2">
                    ${bannerHtml}
                    
                    <!-- Mobile Search Bar (Only visible on mobile) -->
                    <div class="md:hidden mb-4">
                         <div class="relative">
                            <input type="text" placeholder="Search mobile..." 
                               class="w-full pl-10 pr-4 py-2 rounded-lg bg-white border border-brand-secondary focus:outline-none focus:border-brand-primary shadow-sm"
                               oninput="handleSearch(this.value)">
                            <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="flex overflow-x-auto gap-3 mb-6 pb-2 scrollbar-hide">
                        ${window.state.categories.map(c => `
                            <div class="flex-shrink-0 flex flex-col items-center gap-1 cursor-pointer min-w-[60px]" onclick="handleSearch('${c}')">
                                <div class="w-14 h-14 rounded-full bg-white shadow-sm flex items-center justify-center border border-brand-secondary">
                                    <i data-lucide="tag" class="text-brand-primary w-5 h-5"></i>
                                </div>
                                <span class="text-[10px] font-medium text-gray-600 text-center leading-tight">${c}</span>
                            </div>
                        `).join('')}
                    </div>

                    <h2 class="text-lg font-bold text-gray-800 mb-3 px-1 border-l-4 border-brand-primary pl-2">Featured Products</h2>
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-6">
                        ${window.state.products.map(productCard).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderProductDetail(id) {
            const p = window.state.products.find(x => x.id === id);
            if(!p) return navigate('home');

 // Added pb-24 to ensure content isn't hidden behind the fixed bottom bar
            document.getElementById('content').innerHTML = `
                <div class="max-w-5xl mx-auto px-4 py-4 pb-32 md:pb-24 relative">
                    <button onclick="navigate('home')" class="mb-4 text-brand-primary flex items-center gap-1 font-medium text-sm"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-brand-secondary overflow-hidden">
                        <div class="grid md:grid-cols-2">
                            <div class="p-6 bg-white flex items-center justify-center border-b md:border-b-0 md:border-r border-brand-secondary">
                                <img src="${p.image}" class="max-h-72 object-contain">
                            </div>
                            <div class="p-5 md:p-8 bg-brand-card">
                                <span class="bg-brand-secondary text-brand-primary text-[10px] font-bold px-2 py-1 rounded uppercase mb-2 inline-block">${p.brand}</span>
                                <h1 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">${p.name}</h1>
                                
                                <div class="flex items-end gap-3 mb-6">
                                    <span class="text-2xl md:text-3xl font-bold text-brand-primary">${formatPrice(p.discountPrice || p.price)}</span>
                                    ${p.discountPrice ? `<span class="text-sm text-gray-400 line-through mb-1">${formatPrice(p.price)}</span>` : ''}
                                </div>

                                <div class="space-y-4 mb-4">
                                    <p class="text-gray-600 leading-relaxed text-sm">${p.desc || 'No description available.'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MOBILE FIXED BOTTOM BAR (Z-INDEX 60 to stay ABOVE nav) -->
                    <div class="fixed bottom-0 left-0 right-0 p-3 bg-white border-t border-gray-200 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] md:static md:bg-transparent md:border-0 md:shadow-none md:p-0 z-[60] flex gap-3">
                        <button onclick="addToCart('${p.id}')" class="flex-1 bg-white border border-brand-primary text-brand-primary py-3 rounded-lg font-bold text-sm">Add to Cart</button>
                        <button onclick="addToCart('${p.id}'); navigate('cart')" class="flex-1 bg-brand-primary text-white py-3 rounded-lg font-bold text-sm shadow-md">Buy Now</button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.addToCart = (id) => {
            const p = window.state.products.find(x => x.id === id);
            const exist = window.state.cart.find(x => x.id === id);
            if(exist) {
                exist.qty++;
            } else {
                window.state.cart.push({ ...p, qty: 1 });
            }
            saveCart();
            renderNavbar();
            showToast("Added to Cart!");
        };

        window.updateQty = (id, delta) => {
            const item = window.state.cart.find(x => x.id === id);
            if(item) {
                item.qty += delta;
                if(item.qty <= 0) window.state.cart = window.state.cart.filter(x => x.id !== id);
                saveCart();
                renderCart();
                renderNavbar();
            }
        };

        function saveCart() {
            localStorage.setItem('wb_cart', JSON.stringify(window.state.cart));
        }

        function renderCart() {
            const total = window.state.cart.reduce((a,b) => a + ((b.discountPrice || b.price) * b.qty), 0);
            
            document.getElementById('content').innerHTML = `
                <div class="max-w-3xl mx-auto px-4 py-4 pb-32">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Shopping Cart</h2>
                    
                    ${window.state.cart.length === 0 ? `
                        <div class="text-center py-12">
                            <p class="text-gray-500 mb-4">Your cart is empty</p>
                            <button onclick="navigate('home')" class="bg-brand-primary text-white px-6 py-2 rounded font-medium text-sm">Start Shopping</button>
                        </div>
                    ` : `
                        <div class="space-y-3 mb-20">
                            ${window.state.cart.map(item => `
                                <div class="bg-white p-3 rounded-lg shadow-sm border border-brand-secondary flex gap-3">
                                    <img src="${item.image}" class="w-16 h-16 object-contain bg-gray-50 rounded">
                                    <div class="flex-1">
                                        <h3 class="font-medium text-gray-800 text-sm line-clamp-1">${item.name}</h3>
                                        <p class="text-brand-primary font-bold text-sm mt-0.5">${formatPrice(item.discountPrice || item.price)}</p>
                                        <div class="flex items-center gap-3 mt-2">
                                            <button onclick="updateQty('${item.id}', -1)" class="w-6 h-6 rounded-full bg-brand-bg text-brand-primary flex items-center justify-center text-sm font-bold">-</button>
                                            <span class="font-medium text-sm w-4 text-center">${item.qty}</span>
                                            <button onclick="updateQty('${item.id}', 1)" class="w-6 h-6 rounded-full bg-brand-bg text-brand-primary flex items-center justify-center text-sm font-bold">+</button>
                                        </div>
                                    </div>
                                    <button onclick="updateQty('${item.id}', -100)" class="text-red-500 self-start p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Fixed Checkout Bar (Z-Index 60 to stay above Nav) -->
                        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] md:static md:shadow-none md:border md:rounded-xl md:mt-6 z-[60]">
                            <div class="max-w-3xl mx-auto flex justify-between items-center gap-4">
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-500">Total:</span>
                                    <span class="text-xl font-bold text-brand-primary">${formatPrice(total)}</span>
                                </div>
                                <button onclick="${window.state.user ? "navigate('checkout')" : "showToast('Please Login First', 'error'); navigate('login')"}" class="bg-brand-primary text-white py-3 px-8 rounded-lg font-bold text-sm shadow-md">Checkout</button>
                            </div>
                        </div>
                    `}
                </div>
            `;
            lucide.createIcons();
        }

        function renderCheckout() {
            const total = window.state.cart.reduce((a,b) => a + ((b.discountPrice || b.price) * b.qty), 0);
            document.getElementById('content').innerHTML = `
                <div class="max-w-2xl mx-auto px-4 py-4 pb-24">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <button onclick="navigate('cart')"><i data-lucide="arrow-left" class="w-5 h-5"></i></button> Checkout
                    </h2>
                    
                    <form id="checkoutForm" onsubmit="placeOrder(event)" class="space-y-4">
                        <div class="bg-white p-4 rounded-xl border border-brand-secondary shadow-sm">
                            <h3 class="font-bold text-brand-primary mb-3 text-xs uppercase">Shipping Details</h3>
                            <div class="space-y-3">
                                <input required name="name" placeholder="Full Name" class="w-full p-2.5 border rounded text-sm focus:border-brand-primary focus:outline-none" value="${window.state.user.displayName || ''}">
                                <input required name="mobile" type="tel" placeholder="Mobile Number" class="w-full p-2.5 border rounded text-sm focus:border-brand-primary focus:outline-none">
                                <textarea required name="address" placeholder="Full Address" rows="2" class="w-full p-2.5 border rounded text-sm focus:border-brand-primary focus:outline-none"></textarea>
                                <div class="grid grid-cols-2 gap-3">
                                    <input required name="city" placeholder="City" class="w-full p-2.5 border rounded text-sm focus:border-brand-primary focus:outline-none">
                                    <input required name="pincode" placeholder="Pincode" class="w-full p-2.5 border rounded text-sm focus:border-brand-primary focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl border border-brand-secondary shadow-sm">
                            <h3 class="font-bold text-brand-primary mb-3 text-xs uppercase">Payment</h3>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 p-3 border rounded-lg bg-gray-50">
                                    <input type="radio" name="payment" value="COD" checked class="accent-brand-primary w-4 h-4">
                                    <span class="text-sm font-medium">Cash on Delivery</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border rounded-lg bg-gray-50">
                                    <input type="radio" name="payment" value="UPI" class="accent-brand-primary w-4 h-4">
                                    <span class="text-sm font-medium">UPI Payment</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-brand-card p-4 rounded-lg flex justify-between items-center mb-4">
                            <span class="font-bold text-gray-700">Total</span>
                            <span class="font-bold text-lg text-brand-primary">${formatPrice(total)}</span>
                        </div>

                        <button type="submit" class="w-full bg-brand-primary text-white py-3.5 rounded-lg font-bold shadow-md">Confirm Order</button>
                    </form>
                </div>
            `;
            lucide.createIcons();
        }

        window.placeOrder = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const orderData = {
                items: window.state.cart,
                total: window.state.cart.reduce((a,b) => a + ((b.discountPrice || b.price) * b.qty), 0),
                customer: {
                    name: formData.get('name'),
                    mobile: formData.get('mobile'),
                    address: formData.get('address'),
                    city: formData.get('city'),
                    pincode: formData.get('pincode'),
                    id: window.state.user.uid,
                    email: window.state.user.email
                },
                paymentMethod: formData.get('payment'),
                status: 'Pending',
                createdAt: serverTimestamp(),
                userId: window.state.user.uid
            };

            if(orderData.paymentMethod === 'UPI') {
                const confirmed = confirm(`Pay to UPI ID: ${window.state.settings.upiId}\nAmount: ${formatPrice(orderData.total)}\n\nClick OK after payment is done.`);
                if(!confirmed) return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                window.state.cart = [];
                saveCart();
                showToast("Order Placed Successfully!");
                navigate('orders');
            } catch(err) {
                console.error(err);
                alert("Order Error: " + err.message);
            }
        };

        function renderOrders() {
            const myOrders = window.state.orders.filter(o => o.userId === window.state.user.uid);
            document.getElementById('content').innerHTML = `
                <div class="max-w-3xl mx-auto px-4 py-4 pb-20">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">My Orders</h2>
                    <div class="space-y-3">
                        ${myOrders.length === 0 ? '<p class="text-gray-500 text-sm text-center py-10">No orders found.</p>' : myOrders.map(o => `
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary">
                                <div class="flex justify-between items-start mb-3 border-b pb-2">
                                    <div>
                                        <span class="font-bold text-brand-primary block text-sm">#${o.id.slice(0,8).toUpperCase()}</span>
                                        <span class="text-[10px] text-gray-500">${o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}</span>
                                    </div>
                                    <span class="px-2 py-1 rounded text-[10px] font-bold ${getStatusColor(o.status)}">${o.status}</span>
                                </div>
                                <div class="space-y-1 mb-3">
                                    ${o.items.map(i => `
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-600">${i.qty}x ${i.name}</span>
                                            <span class="font-medium">${formatPrice(i.discountPrice || i.price)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex justify-between items-center pt-2 border-t text-sm font-bold text-gray-800">
                                    <span>Total</span>
                                    <span>${formatPrice(o.total)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const getStatusColor = (s) => {
            if(s === 'Pending') return 'bg-yellow-100 text-yellow-800';
            if(s === 'Approved') return 'bg-blue-100 text-blue-800';
            if(s === 'Shipped') return 'bg-purple-100 text-purple-800';
            if(s === 'Delivered') return 'bg-green-100 text-green-800';
            return 'bg-red-100 text-red-800';
        }

        function renderAuth(type) {
            const isLogin = type === 'login';
            document.getElementById('content').innerHTML = `
                <div class="min-h-[70vh] flex items-center justify-center px-4">
                    <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-lg border border-brand-secondary">
                        <h2 class="text-xl font-bold text-center text-brand-primary mb-6">${isLogin ? 'Login' : 'Register'}</h2>
                        <form onsubmit="${isLogin ? 'login(event)' : 'register(event)'}" class="space-y-4">
                            <input name="email" type="email" placeholder="Email" required class="w-full p-3 border rounded-lg focus:border-brand-primary outline-none">
                            <input name="password" type="password" placeholder="Password" required minlength="6" class="w-full p-3 border rounded-lg focus:border-brand-primary outline-none">
                            <button class="w-full bg-brand-primary text-white py-3 rounded-lg font-bold">${isLogin ? 'Login' : 'Register'}</button>
                        </form>
                        <p class="text-center mt-6 text-sm text-gray-600">
                            ${isLogin ? "New user?" : "Have account?"} 
                            <button onclick="navigate('${isLogin ? 'register' : 'login'}')" class="text-brand-primary font-bold">${isLogin ? 'Sign Up' : 'Login'}</button>
                        </p>
                    </div>
                </div>
            `;
        }
// --- ADMIN SECTION ---
        function renderAdminDashboard() {
            if(!window.state.isAdmin) return navigate('home');
            
            const totalRevenue = window.state.orders.reduce((a,b) => a + (b.status !== 'Rejected' ? b.total : 0), 0);
            const pending = window.state.orders.filter(o => o.status === 'Pending').length;

            document.getElementById('content').innerHTML = `
                <div class="flex min-h-screen bg-brand-bg pb-20">
                    <!-- Desktop Sidebar -->
                    <div class="w-64 bg-white shadow-lg hidden md:block fixed h-full">
                        <div class="p-6 font-bold text-xl text-brand-primary border-b">Admin Panel</div>
                        <nav class="p-4 space-y-2">
                            <button onclick="navigate('admin-dashboard')" class="w-full text-left p-3 rounded bg-brand-bg text-brand-primary font-bold">Dashboard</button>
                            <button onclick="navigate('admin-products')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600">Products</button>
                            <button onclick="navigate('admin-orders')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600">Orders (${pending})</button>
                            <button onclick="navigate('admin-banners')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600">Banners</button>
                            <button onclick="navigate('home')" class="w-full text-left p-3 rounded hover:bg-gray-50 text-gray-600 mt-8 border-t">Back to Store</button>
                        </nav>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 p-4 md:ml-64">
                        <h2 class="text-xl font-bold text-gray-800 mb-4 md:hidden">Admin Dashboard</h2>
                        
                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-brand-primary">
                                <h3 class="text-gray-500 text-[10px] font-bold uppercase">Revenue</h3>
                                <p class="text-lg font-bold text-gray-800">${formatPrice(totalRevenue)}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-400">
                                <h3 class="text-gray-500 text-[10px] font-bold uppercase">Pending</h3>
                                <p class="text-lg font-bold text-gray-800">${pending}</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-400">
                                <h3 class="text-gray-500 text-[10px] font-bold uppercase">Orders</h3>
                                <p class="text-lg font-bold text-gray-800">${window.state.orders.length}</p>
                            </div>
                             <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-400">
                                <h3 class="text-gray-500 text-[10px] font-bold uppercase">Products</h3>
                                <p class="text-lg font-bold text-gray-800">${window.state.products.length}</p>
                            </div>
                        </div>

                        <!-- MOBILE ADMIN MENU (Visible only on mobile) -->
                        <h3 class="text-sm font-bold text-gray-600 mb-3 md:hidden">Quick Actions</h3>
                        <div class="md:hidden grid grid-cols-2 gap-3 mb-6">
                             <button onclick="navigate('admin-products')" class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary flex flex-col items-center gap-2">
                                <i data-lucide="package" class="text-brand-primary"></i>
                                <span class="font-bold text-sm">Products</span>
                             </button>
                             <button onclick="navigate('admin-orders')" class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary flex flex-col items-center gap-2">
                                <i data-lucide="shopping-bag" class="text-brand-primary"></i>
                                <span class="font-bold text-sm">Orders</span>
                             </button>
                             <button onclick="navigate('admin-banners')" class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary flex flex-col items-center gap-2">
                                <i data-lucide="image" class="text-brand-primary"></i>
                                <span class="font-bold text-sm">Banners</span>
                             </button>
                             <button onclick="navigate('home')" class="bg-white p-4 rounded-lg shadow-sm border border-brand-secondary flex flex-col items-center gap-2">
                                <i data-lucide="home" class="text-brand-primary"></i>
                                <span class="font-bold text-sm">Store View</span>
                             </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminProducts() {
            if(!window.state.isAdmin) return;
            document.getElementById('content').innerHTML = `
                <div class="max-w-6xl mx-auto p-4 pb-24 md:ml-64">
                    <!-- Mobile Back Button -->
                    <button onclick="navigate('admin-dashboard')" class="md:hidden mb-4 flex items-center gap-1 text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Dashboard</button>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Products</h2>
                        <button onclick="document.getElementById('addProductModal').classList.remove('hidden')" class="bg-brand-primary text-white px-3 py-2 rounded text-sm font-bold flex items-center gap-2 shadow-md"><i data-lucide="plus" class="w-4 h-4"></i> Add</button>
                    </div>

                    <div class="space-y-3 md:space-y-0">
                        <!-- Mobile View: Card Style -->
                        <div class="md:hidden space-y-3">
                            ${window.state.products.map(p => `
                                <div class="bg-white p-3 rounded-lg shadow-sm border border-brand-secondary flex gap-3">
                                    <img src="${p.image}" class="w-16 h-16 object-contain rounded bg-gray-50">
                                    <div class="flex-1">
                                        <div class="font-bold text-sm text-gray-800 line-clamp-1">${p.name}</div>
                                        <div class="text-xs text-gray-500 mb-1">${p.brand}</div>
                                        <div class="font-bold text-brand-primary text-sm">${formatPrice(p.discountPrice || p.price)}</div>
                                        <div class="flex justify-between items-center mt-2">
                                            <span class="text-[10px] px-2 py-0.5 rounded ${p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${p.stock} Stock</span>
                                            <button onclick="deleteProduct('${p.id}')" class="text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Desktop View: Table -->
                        <div class="hidden md:block bg-white rounded-lg shadow overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-bold"><tr><th class="p-3">Img</th><th class="p-3">Name</th><th class="p-3">Price</th><th class="p-3">Stock</th><th class="p-3">Action</th></tr></thead>
                                <tbody class="divide-y divide-gray-100 text-sm">
                                    ${window.state.products.map(p => `
                                        <tr>
                                            <td class="p-3"><img src="${p.image}" class="w-10 h-10 object-contain"></td>
                                            <td class="p-3 font-medium">${p.name}</td>
                                            <td class="p-3">${formatPrice(p.discountPrice || p.price)}</td>
                                            <td class="p-3">${p.stock}</td>
                                            <td class="p-3"><button onclick="deleteProduct('${p.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add Product Modal (Responsive) -->
                    <div id="addProductModal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl w-full max-w-lg max-h-[85vh] overflow-y-auto shadow-2xl">
                            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                                <h3 class="font-bold">Add Product</h3>
                                <button onclick="document.getElementById('addProductModal').classList.add('hidden')"><i data-lucide="x"></i></button>
                            </div>
                            <form onsubmit="addProduct(event)" class="p-4 space-y-3">
                                <input name="name" required placeholder="Name" class="w-full p-2 border rounded">
                                <div class="grid grid-cols-2 gap-3">
                                    <input name="brand" required placeholder="Brand" class="w-full p-2 border rounded">
                                    <select name="category" class="w-full p-2 border rounded">
                                        ${window.state.categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <input name="price" type="number" required placeholder="Price" class="w-full p-2 border rounded">
                                    <input name="discountPrice" type="number" placeholder="Discount Price" class="w-full p-2 border rounded">
                                </div>
                                <input name="stock" type="number" required placeholder="Stock" class="w-full p-2 border rounded">
                                <textarea name="desc" placeholder="Description" rows="2" class="w-full p-2 border rounded"></textarea>
                                <input type="file" required id="prodImgInput" accept="image/*" class="w-full text-sm">
                                <button type="submit" id="addProdBtn" class="w-full bg-brand-primary text-white py-3 rounded font-bold">Add Product</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.addProduct = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('addProdBtn');
            const origText = btn.innerText;
            btn.innerText = "Uploading...";
            btn.disabled = true;

            try {
                const file = document.getElementById('prodImgInput').files[0];
                const url = await uploadImage(file);

                if(url) {
                    const formData = new FormData(e.target);
                    const data = {
                        name: formData.get('name'),
                        brand: formData.get('brand'),
                        category: formData.get('category'),
                        price: Number(formData.get('price')),
                        discountPrice: Number(formData.get('discountPrice')) || null,
                        stock: Number(formData.get('stock')),
                        desc: formData.get('desc'),
                        image: url,
                        createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), data);
                    document.getElementById('addProductModal').classList.add('hidden');
                    e.target.reset();
                    showToast("Product Added!");
                }
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.innerText = origText;
                btn.disabled = false;
            }
        };

        window.deleteProduct = async (id) => {
            if(confirm("Delete this product?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                showToast("Deleted");
            }
        };

        function renderAdminOrders() {
            if(!window.state.isAdmin) return;
            document.getElementById('content').innerHTML = `
                <div class="max-w-6xl mx-auto p-4 pb-24 md:ml-64">
                    <button onclick="navigate('admin-dashboard')" class="md:hidden mb-4 flex items-center gap-1 text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Dashboard</button>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Orders</h2>
                    <div class="space-y-4">
                        ${window.state.orders.map(o => `
                            <div class="bg-white p-4 rounded-lg shadow border border-brand-secondary">
                                <div class="flex flex-col gap-2 mb-3 border-b pb-3">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <span class="font-bold text-brand-primary">#${o.id.slice(0,6).toUpperCase()}</span>
                                            <div class="text-xs text-gray-500">${o.customer.name}</div>
                                        </div>
                                        <select onchange="updateStatus('${o.id}', this.value)" class="p-1 text-xs border rounded bg-gray-50 font-bold">
                                            ${['Pending', 'Approved', 'Shipped', 'Delivered', 'Rejected'].map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="text-xs text-gray-600">
                                        Mobile: ${o.customer.mobile}<br>
                                        Address: ${o.customer.address}, ${o.customer.city}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded text-xs space-y-1">
                                    ${o.items.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name}</span><span>${formatPrice(i.price)}</span></div>`).join('')}
                                    <div class="flex justify-between font-bold pt-2 border-t mt-2">
                                        <span>Total (${o.paymentMethod})</span>
                                        <span>${formatPrice(o.total)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status });
            showToast("Updated");
        };

        function renderAdminBanners() {
            if(!window.state.isAdmin) return;
            document.getElementById('content').innerHTML = `
                <div class="max-w-4xl mx-auto p-4 pb-24 md:ml-64">
                    <button onclick="navigate('admin-dashboard')" class="md:hidden mb-4 flex items-center gap-1 text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Dashboard</button>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Banners</h2>
                    
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-6 border border-brand-secondary">
                        <h3 class="font-bold text-sm mb-3">Upload New</h3>
                        <div class="flex flex-col gap-3">
                            <input type="file" id="bannerInput" class="w-full p-2 border rounded text-sm">
                            <button onclick="uploadBanner()" class="bg-brand-primary text-white py-2 rounded font-bold text-sm">Upload Banner</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${window.state.banners.map(b => `
                            <div class="relative group bg-white rounded-lg overflow-hidden shadow">
                                <img src="${b.url}" class="w-full h-32 object-cover">
                                <div class="absolute bottom-0 left-0 right-0 bg-black/60 p-2 flex justify-between items-center">
                                    <span class="text-white text-xs font-bold">${b.active ? 'Active' : 'Inactive'}</span>
                                    <div class="flex gap-2">
                                        <button onclick="toggleBanner('${b.id}', ${!b.active})" class="text-xs bg-white px-2 py-1 rounded font-bold">${b.active ? 'Disable' : 'Enable'}</button>
                                        <button onclick="deleteBanner('${b.id}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.uploadBanner = async () => {
            const file = document.getElementById('bannerInput').files[0];
            if(!file) return showToast("Select file", 'error');
            
            showToast("Uploading...", 'info');
            const url = await uploadImage(file);
            if(url) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), { url, active: true, createdAt: serverTimestamp() });
                showToast("Banner Uploaded!");
                document.getElementById('bannerInput').value = '';
            }
        };

        window.deleteBanner = async (id) => {
            if(confirm("Delete banner?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id));
        };
        
        window.toggleBanner = async (id, active) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id), { active });
        };
      // --- Init ---
        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            window.state.isAdmin = user && user.email === ADMIN_EMAIL;
            renderNavbar();
            listenToData();
        });

        renderNavbar();
        renderHome();
    </script>
</body>
</html>

